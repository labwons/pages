<!DOCTYPE html>
<html lang="ko">
<head>
    <title>L￦ :: MAPS</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../src/css/map.css">

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="../src/js/marketmap.js"></script>
</head>
<body>
    <header></header>
    <main id="main">
        <section id="market-map">
            <div class="map-ads">
                <div class="map-ads-content">광고 영역(자동 높이)</div>
            </div>
            <div class="map-nav">
                <div class="map-nav-1">
                    <div class="map-nav-mobi">
                        <select class="map-select" name="">
                            <optgroup label="WICS">
                                <option value="indful" selected="selected">WICS 대형주</option>
                                <option value="indksm">WICS 중형주</option>
                            </optgroup>
                            <optgroup label="WI26">
                                <option value="secful">WI26 대형주</option>
                                <option value="secksm">WI26 중형주</option>
                            </optgroup>
                            <optgroup label="ETF">
                                <option value="etfful">ETF</option>
                            </optgroup>
                        </select>
                        <select class="option-select" name="지표">
                            <option value="R1D">1일 수익률</option>
                            <option value="R1W">1주 수익률</option>
                            <option value="R1M">1개월 수익률</option>
                            <option value="R3M">3개월 수익률</option>
                            <option value="R6M">6개월 수익률</option>
                            <option value="R1Y">1년 수익률</option>
                            <option value="PER">PER</option>
                            <option value="PBR">PBR</option>
                            <option value="DIV">배당 수익률</option>
                        </select>
                    </div>
                    <input id="map-reset" class="map-reset" type="button" value="&nbsp;" />
                </div>
                <div class="map-nav-2">
                    <select class="map-search">
                        <option></option>
                    </select>
                </div>
                <div style="clear: both;"></div>
            </div>
      
            <div id="myMap">&nbsp;</div>
            <div class="map-guide">
                <div class="map-guide-bar">
                    <div id="s_red" class="map-color-unit">하락</div>
                    <div id="m_red" class="map-color-unit">&nbsp;</div>
                    <div id="l_red" class="map-color-unit">&nbsp;</div>
                    <div id="navy" class="map-color-unit">보합</div>
                    <div id="l_grn" class="map-color-unit">&nbsp;</div>
                    <div id="m_grn" class="map-color-unit">&nbsp;</div>
                    <div id="s_grn" class="map-color-unit">상승</div>
                </div>
                <div class="map-notice">
                    본 자료는 투자 참고용입니다. 색상은 상대 지표로 표현하였습니다. PC에서 지도에 커서를 올리거나 모바일에서 꾸욱 누르면 정보가 나타납니다(일부 기기 제외). 해당 종목이나 분류를 클릭하면 확대/재편됩니다. *표시는 코스닥 종목입니다. 종목 구성이 많을수록 속도가 느려질 수 있습니다. 일부 지도에서는 가독성을 위해 소형주는 제외되었습니다.
                </div>
            </div>
        </section>
      
    </main><!-- End #main -->

    <script type="text/javascript" id="marketdata"></script>
    <script type="text/javascript">
        const static_log = "https://raw.githubusercontent.com/Jehoshaphat-kr/tdatlib/master/snob/market/archive/deploy/marketdatav.txt"
        const static_url = "https://raw.githubusercontent.com/Jehoshaphat-kr/tdatlib/master/snob/market/archive/deploy/marketdata.js"
        fetch(static_url, {method: 'GET'})
        .then((response) => response.text())
        .then(data => {
            $("#marketdata").html(data);
            $('#market-date').html(trading_date);
            $('.map-select').prop('selectedIndex',0);
            $('.option-select').prop('selectedIndex',0);
            $('.map-search').select2({placeholder:"종목명 검색..", allowClear: true});
            market_type = $('.map-select').val();
            option_type = $('.option-select').val();
            map_key = market_type;
            treemap(map_key);
            setSearch(map_key);
        })

        $(document).ready(function(){
        // MAP type selection
        $('.map-select').on('change', function(){
            $('.option-select option[value="PER"]').remove();
            $('.option-select option[value="PBR"]').remove();
            $('.option-select option[value="DIV"]').remove();
            map_type = $('.map-select').val()

            if (map_type != 'etfful'){
            $('.option-select').append('<option value="PER">PER</option>');
            $('.option-select').append('<option value="PBR">PBR</option>');
            $('.option-select').append('<option value="DIV">배당수익률</option>');
            }

            map_key = map_type;
            treemap(map_key);
            setSearch(map_key);
        })

        // Option selection
        $(".option-select").on('change', function(){
            option_type = $(".option-select").val();
            treemap(map_key);
        if ((option_type == 'PER') || (option_type == 'PBR')){
            $("#s_red").html('고평가');
            $("#navy").html('평균');
            $("#s_grn").html('저평가');
        } else if (option_type == 'DIV'){
            $("#s_red").html('저배당');
            $("#navy").html('평균');
            $("#s_grn").html('고배당');
        } else {
            $("#s_red").html('하락');
            $("#navy").html('보합');
            $("#s_grn").html('상승');
        }
        })

        // MAP Search
        $('.map-search').on('select2:select', function (e) {
            var username = e.params.data.text;
            if (username == "") { return }

            var i_start = username.indexOf('[');
            if (i_start != -1){
            var group = username.slice(i_start + 1, username.length - 1);
            username = username.slice(0, i_start);
            } else if (group_data.includes(username)) {
            var group = username;
            } else{
            var idx = tdat_name.indexOf(username);
            var group = tdat_covers[map_key][idx];
            }

            search_top(group);
            if (username == group){return}
            setTimeout(function(){
            search_asset(username);
            }, 1000)
        });

        // MAP Reset
        $('#map-reset').click(function(){
            treemap(map_key);
        })
        })
    </script>
      
    
</body>
</html>
