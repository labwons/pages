const isLabTop=window.matchMedia("(max-width: 1443px)"),isTablet=window.matchMedia("(max-width: 1023px)"),isMobile=window.matchMedia("(max-width: 767px)"),isNarrow=window.matchMedia("(max-width: 374px)"),abs=e=>e.map(Math.abs);let SRC=null,EVE=document.createEvent("MouseEvent");var mapTyp="WS",mapFrm=null,barTyp="industry",comOpt="D-1",viewMd="treemap";function setFrame(){mapFrm=SRC.TICKERS,Object.values(SRC[mapTyp]).forEach(e=>{mapFrm=Object.assign({},mapFrm,e)})}function setTypeSelector(){"treemap"==viewMd?($(".map-type").empty().append('<option value="WS">대형주</option>').append('<option value="NS">대형주(삼성전자 제외)</option>'),$('.map-type option[value="'+mapTyp+'"]').prop("selected",!0)):($(".map-type").empty().append('<option value="sector">섹터 Sector</option>').append('<option value="industry">업종 Industry</option>'),$('.map-type option[value="'+barTyp+'"]').prop("selected",!0))}function setOptionSelector(){Object.entries(SRC.METADATA).forEach(([e,a])=>{"DATE"!=e&&"DUPLICATEDGROUP"!=e&&$(".map-option").append('<option value="'+e+'">'+a.label+"</option>")}),$('.map-option option[value="'+comOpt+'"]').prop("selected",!0)}function setSearchSelector(){$(".map-searchbar").select2({placeholder:"종목명/섹터/업종"}).empty().append("<option></option>"),$(".map-searchbar").append('<optgroup label="[종목 / Stocks]">'),Object.entries(SRC.TICKERS).sort((e,a)=>a[1].size-e[1].size).forEach(e=>{("NS"!==mapTyp||"005930"!==e[0])&&$(".map-searchbar").append('<option value="'+e[0]+'">'+e[1].name+"</option>")}),$(".map-searchbar").append('<optgroup label="[섹터 / Sectors]">'),Object.entries(SRC[mapTyp].sector).forEach(([e,a])=>{$(".map-searchbar").append('<option value="'+e+'">'+a.name+"</option>")}),$(".map-searchbar").append('<optgroup label="[업종 / Industries]">'),Object.entries(SRC[mapTyp].industry).forEach(([e,a])=>{$(".map-searchbar").append('<option value="'+e+'">'+a.name+"</option>")})}function setScale(){var e=SRC.METADATA[comOpt];$(".map-legend span").each(function(a){null==e.bound[a]?$(this).html("&nbsp; - &nbsp;"):$(this).html(String(e.bound[a])+e.unit),$(this).css("background-color",e.scale[a])})}function setTreemapLayout(){return{margin:{l:0,r:0,t:0,b:25},annotations:[{x:1,y:1,xref:"paper",yref:"paper",text:SRC.METADATA.DATE + ' ',showarrow:!1,xanchor:"right",yanchor:"top",font:{size:12,color:"white"}}]}}function setBarLayout(){return{margin:{l:10,r:0,t:10,b:22},xaxis:{autorange:!1,showticklabels:!1,showline:!1,range:[0,0]},yaxis:{showline:!1,zeroline:!1,showticklabels:!1},dragmode:!1}}function setTreemapOption(){return{displayModeBar:!1,responsive:!0,showTips:!1}}function setBarOption(){return{scrollZoom:!1,displayModeBar:!1,responsive:!0,showTips:!1}}function clickTreemap(e){for(var a=$("g.slicetext"),t=0;t<a.length;t++)if($(a[t]).text().includes(e)){$(a[t]).get(0).dispatchEvent(EVE);return}}function rewindOn(){$(".map-rewind").attr("class").includes("show")||$(".map-rewind").toggleClass("show")}function rewindOff(){$(".map-rewind").attr("class").includes("show")&&$(".map-rewind").toggleClass("show")}function setTreemap(){var e=SRC.METADATA[comOpt],a=setTreemapLayout(),t=setTreemapOption(),r="NanumGothic, Nanum Gothic, Open Sans, sans-serif",o=[],s=[],p=[],n=[],i=[],c=[],l=[];Object.entries(mapFrm).forEach(([e,a])=>{("NS"!=mapTyp||"삼성전자"!=a.name)&&(s.push(a.name),p.push(a.ceiling),n.push(a.size),o.push(e),i.push(a.meta),c.push(a[comOpt][0]),l.push(a[comOpt][1]))}),Plotly.newPlot("market-map",[{type:"treemap",branchvalues:"total",labels:s,parents:p,values:n,customdata:o,meta:i,text:c,textposition:"middle center",textfont:{family:r,color:"#ffffff"},texttemplate:"%{label}<br>%{text}",hovertemplate:"%{meta}"+e.label+": %{text}<extra></extra>",hoverlabel:{font:{family:r,color:"#ffffff"}},opacity:.9,marker:{colors:l,visible:!0}}],a,t)}function setBarChart(){var e=SRC.METADATA[comOpt],a=setBarLayout(),t=setBarOption(),r=Object.values(SRC.WS[barTyp]),o=[],s=[],p=[],n=[],i=[];"industry"==barTyp&&SRC.METADATA.DUPLICATEDGROUP.forEach(e=>{r.push(SRC.WS.sector[e])}),r.forEach(a=>{a.n=parseFloat(a[comOpt][0].replace(e.unit,"")),a.x=Math.abs(a.n)}),r.sort((e,a)=>a.n-e.n);var c=Math.max(...r.map(e=>e.x));if(r.forEach(e=>{o.push(e.x+.45*c),s.push(e.name),p.push(e[comOpt][0]),n.push(e.meta),i.push(e[comOpt][1])}),isNarrow.matches)var l=1.35*c;else if(isMobile.matches)var l=1.3*c;else if(isTablet.matches)var l=1.2*c;else var l=1.1*c;a.xaxis.range=[0,1.45*l],a.annotations=s.map(e=>({x:0,y:e,xref:"x",yref:"y",text:e,showarrow:!1,font:{color:"white",size:13},xanchor:"left",yanchor:"middle"})),Plotly.newPlot("market-map",[{type:"bar",x:o.reverse(),y:s.reverse(),orientation:"h",marker:{color:i.reverse()},text:p.reverse(),textposition:"outside",meta:n.reverse(),hovertemplate:"%{meta}"+e.label+": %{text}<extra></extra>",opacity:.9}],a,t)}EVE.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),$(document).ready(async function(){try{let e=await fetch("../../dev/json/service/treemap.json");if(!e.ok)throw Error("Network response was not ok");SRC=await e.json(),setTypeSelector(),setOptionSelector(),setFrame(),setTreemap(),setScale(),setSearchSelector()}catch(a){console.error("Fetch error:",a)}$(".map-type").on("change",function(){"treemap"==viewMd?(mapTyp=$(this).val(),setFrame(),setTreemap(),setSearchSelector()):(barTyp=$(this).val(),setBarChart())}),$(".map-option").on("change",function(){comOpt=$(this).val(),"treemap"==viewMd?setTreemap():setBarChart(),setScale()}),$(".map-reset").click(function(){setTreemap(),rewindOff(),setSearchSelector()}),$(".map-switch i").click(function(){$(this).attr("class").includes("fa-map-o")?(viewMd="bar",setBarChart(),rewindOff(),$(this).removeClass("fa-map-o").addClass("fa-signal"),$(".map-searchbar").prop("disabled",!0)):(viewMd="treemap",setTreemap(),$(this).removeClass("fa-signal").addClass("fa-map-o"),$(".map-searchbar").prop("disabled",!1)),setTypeSelector()}),$(".map-searchbar").on("select2:select",function(e){var a=e.params.data.id;if(a.startsWith("W")){var t=SRC[mapTyp].industry[a];clickTreemap(t.name);return}if(a.startsWith("G")){var t=SRC[mapTyp].sector[a];clickTreemap(t.name);return}var t=SRC.TICKERS[a];clickTreemap(t.ceiling),setTimeout(function(){clickTreemap(t.name)},1e3)}),$(".map-rewind").click(function(){"bar"!=viewMd&&($(".slice").get(0).dispatchEvent(EVE),rewindOff())}),$("#market-map").on("plotly_click",function(e,a){if("bar"!=viewMd){if(1==$("g.slice").length)rewindOff();else{if(a.points[0].customdata.startsWith("W")||a.points[0].customdata.startsWith("G")||a.points[0].customdata.startsWith("T"))return;rewindOn()}}})});