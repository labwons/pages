const __URL__="../../../src/json/treemap/treemap.json",isLabTop=window.matchMedia("(max-width: 1443px)"),isTablet=window.matchMedia("(max-width: 1023px)"),isMobile=window.matchMedia("(max-width: 767px)"),isNarrow=window.matchMedia("(max-width: 374px)"),abs=e=>e.map(Math.abs);let __SRC__=null,E_MOUSE=document.createEvent("MouseEvent");var base=null,data=null,spec=null,tops=null,view="map",maxRange=1.1;function getCoverNames(){tops=[];for(var e=base.meta.length-2;e>0;e--)if(tops.push(base.name[e]),base.meta[e].includes("종가"))return tops;return tops}function searchReset(){$(".map-searchbar").empty(),$(".map-searchbar").append("<option></option>");for(var e=0;e<base.name.length;e++)$(".map-searchbar").append("<option>"+base.name[e]+"</option>")}function clickTreemap(e){for(var a=$("g.slicetext"),t=0;t<a.length;t++)if($(a[t]).text().includes(e))return void $(a[t]).get(0).dispatchEvent(E_MOUSE)}function rewindOn(){$(".map-rewind").attr("class").includes("show")||$(".map-rewind").toggleClass("show")}function rewindOff(){$(".map-rewind").attr("class").includes("show")&&$(".map-rewind").toggleClass("show")}function updateMap(){unit="PER"==spec||"PBR"==spec?"":"%",data=[{type:"treemap",branchvalues:"total",labels:base.name,parents:base.cover,values:base.size,meta:base.meta,text:base[spec],textposition:"middle center",textfont:{family:"NanumGothic, Nanum Gothic, Open Sans, sans-serif",color:"#ffffff"},texttemplate:"%{label}<br>%{text:.2f}"+unit,hovertemplate:"%{meta}<br>"+spec+": %{text}"+unit+"<extra></extra>",hoverlabel:{font:{family:"NanumGothic, Nanum Gothic, Open Sans, sans-serif",color:"#ffffff"}},opacity:.9,marker:{colors:base[spec+"-C"],visible:!0},root_color:"lightgrey"}],Plotly.newPlot("market-map",data,{margin:{l:0,r:0,t:0,b:25},annotations:[{x:1,y:1,xref:"paper",yref:"paper",text:__SRC__.Date,showarrow:!1,xanchor:"right",yanchor:"top",font:{size:10,color:"white"}}]},{displayModeBar:!1,responsive:!0,showTips:!1})}function updateBar(){let e={},a=base[spec].map(((e,a)=>a));var t,p="%",m={margin:{l:10,r:0,t:10,b:22},xaxis:{autorange:!1,showticklabels:!1,showline:!1,range:[0,0]},yaxis:{showline:!1,zeroline:!1,showticklabels:!1},dragmode:!1};for(var s in"PER"!=spec&&"PBR"!=spec||(p=""),a.sort(((e,a)=>base[spec][e]-base[spec][a])),base)e[s]=a.map((e=>base[s][e]));maxRange=isNarrow.matches?1.35*Math.max(...abs(e[spec])):isMobile.matches?1.3*Math.max(...abs(e[spec])):isTablet.matches?1.2*Math.max(...abs(e[spec])):1.1*Math.max(...abs(e[spec])),t=.45*maxRange,m.xaxis.range=[0,maxRange+t],m.annotations=e.name.map((function(e,a){return{x:0,y:e,xref:"x",yref:"y",text:e,showarrow:!1,font:{color:"white",size:13},xanchor:"left",yanchor:"middle"}})),data=[{type:"bar",x:abs(e[spec]).map((function(e){return e+t})),y:e.name,orientation:"h",marker:{color:e[spec+"-C"]},text:e[spec],texttemplate:"%{text}"+p,textposition:"outside",meta:e.meta,hovertemplate:"%{meta}<br>"+spec+": %{text}"+p+"<extra></extra>",opacity:.9}],Plotly.newPlot("market-map",data,m,{scrollZoom:!1,displayModeBar:!1,responsive:!0,showTips:!1})}$(document).ready((async function(){try{const e=await fetch(__URL__);if(!e.ok)throw new Error("Network response was not ok");__SRC__=await e.json()}catch(e){console.error("Fetch error:",e)}$(".map-date").html(__SRC__.Date),base=__SRC__[$(".map-type").val()],spec=$(".map-option").val(),tops=getCoverNames(),updateMap(),searchReset()})),$(document).ready((function(){$("#header").attr("class").includes("header-fix")&&$("#header").removeClass("header-fix"),$(".map-searchbar").select2({placeholder:"종목명/섹터/업종"}),E_MOUSE.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),$(".map-type").on("change",(function(){base=__SRC__[$(".map-type").val()],"map"==view?(tops=getCoverNames(),updateMap(),searchReset()):updateBar()})),$(".map-option").on("change",(function(){spec=$(".map-option").val(),"map"==view?updateMap():updateBar(),"PER"==spec||"PBR"==spec?($(".map-lowest").html("고평가"),$(".map-lower").html(""),$(".map-low").html(""),$(".map-middle").html("평균"),$(".map-high").html(""),$(".map-higher").html(""),$(".map-highest").html("저평가")):"DIV"==spec?($(".map-lowest").html(""),$(".map-lower").html(""),$(".map-low").html(""),$(".map-middle").html("0%"),$(".map-high").html("2%"),$(".map-higher").html("4%"),$(".map-highest").html("6%")):"D-1"==spec?($(".map-lowest").html("-3%"),$(".map-lower").html("-2%"),$(".map-low").html("-1%"),$(".map-middle").html("0%"),$(".map-high").html("1%"),$(".map-higher").html("2%"),$(".map-highest").html("3%")):"W-1"==spec?($(".map-lowest").html("-6%"),$(".map-lower").html("-4%"),$(".map-low").html("-2%"),$(".map-middle").html("0%"),$(".map-high").html("2%"),$(".map-higher").html("4%"),$(".map-highest").html("6%")):"M-1"==spec?($(".map-lowest").html("-10%"),$(".map-lower").html("-6.7%"),$(".map-low").html("-3.3%"),$(".map-middle").html("0%"),$(".map-high").html("3.3%"),$(".map-higher").html("6.7%"),$(".map-highest").html("10%")):"M-3"==spec?($(".map-lowest").html("-18%"),$(".map-lower").html("-12%"),$(".map-low").html("-6%"),$(".map-middle").html("0%"),$(".map-high").html("6%"),$(".map-higher").html("12%"),$(".map-highest").html("18%")):"M-6"==spec?($(".map-lowest").html("-24%"),$(".map-lower").html("-16%"),$(".map-low").html("-8%"),$(".map-middle").html("0%"),$(".map-high").html("8%"),$(".map-higher").html("16%"),$(".map-highest").html("24%")):"Y-1"==spec&&($(".map-lowest").html("-30%"),$(".map-lower").html("-20%"),$(".map-low").html("-10%"),$(".map-middle").html("0%"),$(".map-high").html("10%"),$(".map-higher").html("20%"),$(".map-highest").html("30%"))})),$(".map-reset").click((function(){updateMap(),rewindOff(),$(".map-searchbar").val(null).trigger("change")})),$(".map-switch").click((function(){var e=$(this).find("i");e.attr("class").includes("fa-map-o")?($(".map-type").empty(),$(".map-type").append('<optgroup label="---- [대형주 / Large Cap]">'),$(".map-type").append('<option value="LargeSectors" selected="selected">섹터</option>'),$(".map-type").append('<option value="LargeIndustries">업종</option>'),$(".map-type").append('<optgroup label="---- [중형주 / Mid Cap]">'),$(".map-type").append('<option value="MidSectors">섹터</option>'),$(".map-type").append('<option value="MidIndustries">업종</option>'),view="bar",e.removeClass("fa-map-o"),e.addClass("fa-signal"),$(".map-searchbar").prop("disabled",!0),$(".map-rewind").attr("class").includes("show")&&rewindOff()):($(".map-type").empty(),$(".map-type").append('<option value="LargeCap" selected="selected">대형주</option>'),$(".map-type").append('<option value="LargeCapWithoutSamsung">대형주(삼성전자 제외)</option>'),$(".map-type").append('<option value="MidCap">중형주</option>'),view="map",e.removeClass("fa-signal"),e.addClass("fa-map-o"),$(".map-searchbar").prop("disabled",!1)),base=__SRC__[$(".map-type").val()],"map"==view?updateMap():updateBar()})),$(".map-searchbar").on("select2:select",(function(e){var a=e.params.data.text;tops.includes(a)?clickTreemap(a):(clickTreemap(base.cover[base.name.indexOf(a)]),setTimeout((function(){clickTreemap(a)}),1e3))})),$(".map-rewind").click((function(){"map"==view&&($(".slice").get(0).dispatchEvent(E_MOUSE),rewindOff())})),$("#market-map").on("plotly_click",(function(e,a){"map"==view&&(1!=$("g.slice").length?tops.includes(a.points[0].label)||rewindOn():rewindOff())}))}));